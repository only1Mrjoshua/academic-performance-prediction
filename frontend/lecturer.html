<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lecturer - Academic Performance System</title>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <nav class="navbar">
      <div class="container">
        <a href="index.html" class="navbar-brand"
          >Academic Performance System</a
        >
        <ul class="navbar-nav">
          <li><a href="index.html">Home</a></li>
          <li><a href="admin.html">Admin</a></li>
          <li><a href="lecturer.html" class="active">Lecturer</a></li>
          <li><a href="dashboard.html">Dashboard</a></li>
        </ul>
      </div>
    </nav>

    <div class="container">
      <!-- Assessments Section -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Manage Assessments</h2>
          <button
            class="btn btn-primary"
            onclick="openModal('assessmentModal')"
          >
            Add Assessment
          </button>
        </div>

        <div class="table-responsive">
          <table class="table" id="assessmentsTable">
            <thead>
              <tr>
                <th>Student</th>
                <th>Course</th>
                <th>Test Score</th>
                <th>Assignment</th>
                <th>Exam Score</th>
                <th>Total</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="assessmentsBody">
              <tr id="assessmentsLoadingRow">
                <td colspan="7" style="text-align: center; padding: 20px">
                  Loading assessments...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Attendance Section -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Manage Attendance</h2>
          <button
            class="btn btn-primary"
            onclick="openModal('attendanceModal')"
          >
            Add Attendance
          </button>
        </div>

        <div class="table-responsive">
          <table class="table" id="attendanceTable">
            <thead>
              <tr>
                <th>Student</th>
                <th>Course</th>
                <th>Attendance %</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="attendanceBody">
              <tr id="attendanceLoadingRow">
                <td colspan="4" style="text-align: center; padding: 20px">
                  Loading attendance records...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Prediction Controls -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">AI Predictions</h2>
        </div>
        <div style="display: flex; gap: 10px; padding: 20px">
          <button class="btn btn-primary" onclick="trainModel()">
            Train Model
          </button>
          <button class="btn btn-secondary" onclick="generateAllPredictions()">
            Generate All Predictions
          </button>
        </div>
      </div>

      <!-- Debug Panel (Remove in production) -->
      <div
        class="card"
        style="
          margin-top: 20px;
          background-color: #f8f9fa;
          border: 1px solid #dee2e6;
        "
      >
        <div class="card-header">
          <h3 class="card-title">Debug Panel</h3>
        </div>
        <div class="card-body">
          <div style="display: flex; gap: 10px; flex-wrap: wrap">
            <button class="btn btn-secondary" onclick="debugAssessments()">
              Debug Assessments
            </button>
            <button class="btn btn-secondary" onclick="debugStudents()">
              Debug Students
            </button>
            <button class="btn btn-secondary" onclick="debugCourses()">
              Debug Courses
            </button>
            <button class="btn btn-warning" onclick="forceReload()">
              Force Reload All
            </button>
          </div>
          <div
            id="debugOutput"
            style="
              margin-top: 15px;
              padding: 15px;
              background: white;
              border: 1px solid #ccc;
              border-radius: 5px;
              max-height: 300px;
              overflow: auto;
              font-family: monospace;
              font-size: 12px;
            "
          >
            Click a debug button to see data...
          </div>
        </div>
      </div>
    </div>

    <!-- Assessment Modal -->
    <div id="assessmentModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('assessmentModal')"
          >&times;</span
        >
        <h2 id="assessmentModalTitle">Add Assessment</h2>
        <form id="assessmentForm" onsubmit="saveAssessment(event)">
          <input type="hidden" id="assessmentId" />
          <div class="form-group">
            <label for="assessmentStudent">Student:</label>
            <select id="assessmentStudent" required>
              <option value="">Select Student</option>
            </select>
          </div>
          <div class="form-group">
            <label for="assessmentCourse">Course:</label>
            <select id="assessmentCourse" required>
              <option value="">Select Course</option>
            </select>
          </div>
          <div class="form-group">
            <label for="testScore">Test Score (0-30):</label>
            <input
              type="number"
              id="testScore"
              min="0"
              max="30"
              step="0.5"
              required
            />
          </div>
          <div class="form-group">
            <label for="assignmentScore">Assignment Score (0-20):</label>
            <input
              type="number"
              id="assignmentScore"
              min="0"
              max="20"
              step="0.5"
              required
            />
          </div>
          <div class="form-group">
            <label for="examScore">Exam Score (0-50):</label>
            <input
              type="number"
              id="examScore"
              min="0"
              max="50"
              step="0.5"
              required
            />
          </div>
          <button type="submit" class="btn btn-primary">Save</button>
          <button
            type="button"
            class="btn btn-secondary"
            onclick="closeModal('assessmentModal')"
          >
            Cancel
          </button>
        </form>
      </div>
    </div>

    <!-- Attendance Modal -->
    <div id="attendanceModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('attendanceModal')"
          >&times;</span
        >
        <h2 id="attendanceModalTitle">Add Attendance</h2>
        <form id="attendanceForm" onsubmit="saveAttendance(event)">
          <input type="hidden" id="attendanceId" />
          <div class="form-group">
            <label for="attendanceStudent">Student:</label>
            <select id="attendanceStudent" required>
              <option value="">Select Student</option>
            </select>
          </div>
          <div class="form-group">
            <label for="attendanceCourse">Course:</label>
            <select id="attendanceCourse" required>
              <option value="">Select Course</option>
            </select>
          </div>
          <div class="form-group">
            <label for="attendancePercentage"
              >Attendance Percentage (0-100):</label
            >
            <input
              type="number"
              id="attendancePercentage"
              min="0"
              max="100"
              step="1"
              required
            />
          </div>
          <button type="submit" class="btn btn-primary">Save</button>
          <button
            type="button"
            class="btn btn-secondary"
            onclick="closeModal('attendanceModal')"
          >
            Cancel
          </button>
        </form>
      </div>
    </div>

    <script src="js/main.js"></script>
    <script>
      // Global variables
      let students = [];
      let courses = [];
      let assessments = [];
      let attendance = [];

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", function () {
        console.log("üìù Lecturer page loaded");
        loadAllData();
      });

      // Load all data in parallel for better performance
      async function loadAllData() {
        try {
          // Show loading states
          showLoading("assessments");
          showLoading("attendance");

          // Load all data in parallel
          const [studentsData, coursesData, assessmentsData, attendanceData] =
            await Promise.all([
              apiCall("/admin/students/").catch((err) => {
                console.error("Failed to load students:", err);
                return [];
              }),
              apiCall("/admin/courses/").catch((err) => {
                console.error("Failed to load courses:", err);
                return [];
              }),
              apiCall("/lecturer/assessments/").catch((err) => {
                console.error("Failed to load assessments:", err);
                return [];
              }),
              apiCall("/lecturer/attendance/").catch((err) => {
                console.error("Failed to load attendance:", err);
                return [];
              }),
            ]);

          // Update global variables
          students = studentsData || [];
          courses = coursesData || [];
          assessments = assessmentsData || [];
          attendance = attendanceData || [];

          console.log("üìä Data loaded:", {
            students: students.length,
            courses: courses.length,
            assessments: assessments.length,
            attendance: attendance.length,
          });

          // Populate dropdowns and display data
          populateSelects();
          displayAssessments();
          displayAttendance();
        } catch (error) {
          console.error("‚ùå Error loading data:", error);
          showAlert("Failed to load data. Please refresh the page.", "danger");
        }
      }

      // Show loading indicators
      function showLoading(type) {
        if (type === "assessments") {
          document.getElementById("assessmentsBody").innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px;">
                            <div style="display: inline-block; width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <p style="margin-top: 10px; color: #666;">Loading assessments...</p>
                        </td>
                    </tr>
                `;
        } else if (type === "attendance") {
          document.getElementById("attendanceBody").innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 30px;">
                            <div style="display: inline-block; width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <p style="margin-top: 10px; color: #666;">Loading attendance...</p>
                        </td>
                    </tr>
                `;
        }
      }

      // Add spinner animation
      const style = document.createElement("style");
      style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
      document.head.appendChild(style);

      // Populate dropdown selects
      function populateSelects() {
        console.log(
          "Populating dropdowns with",
          students.length,
          "students and",
          courses.length,
          "courses",
        );

        // Assessment student select
        const assessmentStudent = document.getElementById("assessmentStudent");
        if (assessmentStudent) {
          assessmentStudent.innerHTML =
            '<option value="">Select Student</option>';
          students.forEach((student) => {
            assessmentStudent.innerHTML += `<option value="${student.id}">${student.name} (${student.matric_no})</option>`;
          });
        }

        // Assessment course select
        const assessmentCourse = document.getElementById("assessmentCourse");
        if (assessmentCourse) {
          assessmentCourse.innerHTML =
            '<option value="">Select Course</option>';
          courses.forEach((course) => {
            assessmentCourse.innerHTML += `<option value="${course.id}">${course.course_code} - ${course.course_title}</option>`;
          });
        }

        // Attendance student select
        const attendanceStudent = document.getElementById("attendanceStudent");
        if (attendanceStudent) {
          attendanceStudent.innerHTML =
            '<option value="">Select Student</option>';
          students.forEach((student) => {
            attendanceStudent.innerHTML += `<option value="${student.id}">${student.name} (${student.matric_no})</option>`;
          });
        }

        // Attendance course select
        const attendanceCourse = document.getElementById("attendanceCourse");
        if (attendanceCourse) {
          attendanceCourse.innerHTML =
            '<option value="">Select Course</option>';
          courses.forEach((course) => {
            attendanceCourse.innerHTML += `<option value="${course.id}">${course.course_code} - ${course.course_title}</option>`;
          });
        }
      }

      // Display assessments in table
      function displayAssessments() {
        console.log("üìù Displaying assessments...");
        const tbody = document.getElementById("assessmentsBody");

        if (!tbody) {
          console.error("‚ùå assessmentsBody element not found!");
          return;
        }

        if (!assessments || assessments.length === 0) {
          tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px; color: #666;">
                            <p style="font-size: 16px; margin-bottom: 10px;">üìä No assessments found</p>
                            <p style="font-size: 14px;">Click "Add Assessment" to create your first assessment.</p>
                        </td>
                    </tr>
                `;
          return;
        }

        let html = "";
        let displayCount = 0;

        assessments.forEach((assessment) => {
          // Find matching student and course
          const student = students.find((s) => s.id === assessment.student_id);
          const course = courses.find((c) => c.id === assessment.course_id);

          if (student && course) {
            const total =
              assessment.test_score +
              assessment.assignment_score +
              assessment.exam_score;
            displayCount++;

            html += `
                        <tr>
                            <td>${student.name}</td>
                            <td>${course.course_code}</td>
                            <td>${assessment.test_score}</td>
                            <td>${assessment.assignment_score}</td>
                            <td>${assessment.exam_score}</td>
                            <td><strong>${total}</strong></td>
                            <td>
                                <button class="btn btn-warning btn-sm" onclick="editAssessment('${assessment.id}')">Edit</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteAssessment('${assessment.id}')">Delete</button>
                            </td>
                        </tr>
                    `;
          } else {
            console.warn("‚ö†Ô∏è Could not match assessment:", {
              assessment,
              studentFound: !!student,
              courseFound: !!course,
            });
          }
        });

        if (displayCount === 0 && assessments.length > 0) {
          html = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px; color: #e74c3c;">
                            <p>‚ùå Found ${assessments.length} assessments but couldn't match with students/courses.</p>
                            <p style="font-size: 12px;">Check console for details.</p>
                        </td>
                    </tr>
                `;
        }

        tbody.innerHTML = html;
        console.log(
          `‚úÖ Displayed ${displayCount} out of ${assessments.length} assessments`,
        );
      }

      // Display attendance in table
      function displayAttendance() {
        console.log("üìä Displaying attendance...");
        const tbody = document.getElementById("attendanceBody");

        if (!tbody) {
          console.error("‚ùå attendanceBody element not found!");
          return;
        }

        if (!attendance || attendance.length === 0) {
          tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 30px; color: #666;">
                            <p style="font-size: 16px; margin-bottom: 10px;">üìã No attendance records found</p>
                            <p style="font-size: 14px;">Click "Add Attendance" to add attendance records.</p>
                        </td>
                    </tr>
                `;
          return;
        }

        let html = "";
        let displayCount = 0;

        attendance.forEach((record) => {
          const student = students.find((s) => s.id === record.student_id);
          const course = courses.find((c) => c.id === record.course_id);

          if (student && course) {
            displayCount++;
            html += `
                        <tr>
                            <td>${student.name}</td>
                            <td>${course.course_code}</td>
                            <td>${record.attendance_percentage}%</td>
                            <td>
                                <button class="btn btn-warning btn-sm" onclick="editAttendance('${record.id}')">Edit</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteAttendance('${record.id}')">Delete</button>
                            </td>
                        </tr>
                    `;
          }
        });

        tbody.innerHTML = html;
        console.log(
          `‚úÖ Displayed ${displayCount} out of ${attendance.length} attendance records`,
        );
      }

      // Assessment CRUD operations
      async function loadAssessments() {
        try {
          assessments = await apiCall("/lecturer/assessments/");
          displayAssessments();
        } catch (error) {
          console.error("Failed to load assessments:", error);
          showAlert("Failed to load assessments", "danger");
        }
      }

      function editAssessment(id) {
        const assessment = assessments.find((a) => a.id === id);
        if (assessment) {
          document.getElementById("assessmentId").value = assessment.id;
          document.getElementById("assessmentStudent").value =
            assessment.student_id;
          document.getElementById("assessmentCourse").value =
            assessment.course_id;
          document.getElementById("testScore").value = assessment.test_score;
          document.getElementById("assignmentScore").value =
            assessment.assignment_score;
          document.getElementById("examScore").value = assessment.exam_score;
          document.getElementById("assessmentModalTitle").textContent =
            "Edit Assessment";
          openModal("assessmentModal");
        }
      }

      async function deleteAssessment(id) {
        if (confirm("Are you sure you want to delete this assessment?")) {
          try {
            await apiCall(`/lecturer/assessments/${id}`, "DELETE");
            showAlert("Assessment deleted successfully");
            await loadAssessments(); // Reload assessments
          } catch (error) {
            console.error("Failed to delete assessment:", error);
            showAlert("Failed to delete assessment", "danger");
          }
        }
      }

      async function saveAssessment(event) {
        event.preventDefault();

        if (!validateForm("assessmentForm")) return;

        const assessmentData = {
          student_id: document.getElementById("assessmentStudent").value,
          course_id: document.getElementById("assessmentCourse").value,
          test_score: parseFloat(document.getElementById("testScore").value),
          assignment_score: parseFloat(
            document.getElementById("assignmentScore").value,
          ),
          exam_score: parseFloat(document.getElementById("examScore").value),
        };

        const assessmentId = document.getElementById("assessmentId").value;

        try {
          if (assessmentId) {
            await apiCall(
              `/lecturer/assessments/${assessmentId}`,
              "PUT",
              assessmentData,
            );
            showAlert("Assessment updated successfully");
          } else {
            await apiCall("/lecturer/assessments/", "POST", assessmentData);
            showAlert("Assessment added successfully");
          }

          closeModal("assessmentModal");
          document.getElementById("assessmentForm").reset();
          document.getElementById("assessmentId").value = "";
          document.getElementById("assessmentModalTitle").textContent =
            "Add Assessment";

          // Reload all data to ensure everything is in sync
          await loadAllData();
        } catch (error) {
          console.error("Failed to save assessment:", error);
          showAlert("Failed to save assessment: " + error.message, "danger");
        }
      }

      // Attendance CRUD operations
      async function loadAttendance() {
        try {
          attendance = await apiCall("/lecturer/attendance/");
          displayAttendance();
        } catch (error) {
          console.error("Failed to load attendance:", error);
          showAlert("Failed to load attendance", "danger");
        }
      }

      function editAttendance(id) {
        const record = attendance.find((a) => a.id === id);
        if (record) {
          document.getElementById("attendanceId").value = record.id;
          document.getElementById("attendanceStudent").value =
            record.student_id;
          document.getElementById("attendanceCourse").value = record.course_id;
          document.getElementById("attendancePercentage").value =
            record.attendance_percentage;
          document.getElementById("attendanceModalTitle").textContent =
            "Edit Attendance";
          openModal("attendanceModal");
        }
      }

      async function deleteAttendance(id) {
        if (
          confirm("Are you sure you want to delete this attendance record?")
        ) {
          try {
            await apiCall(`/lecturer/attendance/${id}`, "DELETE");
            showAlert("Attendance deleted successfully");
            await loadAttendance(); // Reload attendance
          } catch (error) {
            console.error("Failed to delete attendance:", error);
            showAlert("Failed to delete attendance", "danger");
          }
        }
      }

      async function saveAttendance(event) {
        event.preventDefault();

        if (!validateForm("attendanceForm")) return;

        const attendanceData = {
          student_id: document.getElementById("attendanceStudent").value,
          course_id: document.getElementById("attendanceCourse").value,
          attendance_percentage: parseFloat(
            document.getElementById("attendancePercentage").value,
          ),
        };

        const attendanceId = document.getElementById("attendanceId").value;

        try {
          if (attendanceId) {
            await apiCall(
              `/lecturer/attendance/${attendanceId}`,
              "PUT",
              attendanceData,
            );
            showAlert("Attendance updated successfully");
          } else {
            await apiCall("/lecturer/attendance/", "POST", attendanceData);
            showAlert("Attendance added successfully");
          }

          closeModal("attendanceModal");
          document.getElementById("attendanceForm").reset();
          document.getElementById("attendanceId").value = "";
          document.getElementById("attendanceModalTitle").textContent =
            "Add Attendance";

          // Reload all data
          await loadAllData();
        } catch (error) {
          console.error("Failed to save attendance:", error);
          showAlert("Failed to save attendance: " + error.message, "danger");
        }
      }

      // Prediction functions
      async function trainModel() {
        try {
          showAlert("Training model...", "info");
          const result = await apiCall("/prediction/train", "POST");
          showAlert(
            "Model trained successfully! Accuracy: " +
              (result.metrics.accuracy * 100).toFixed(2) +
              "%",
          );
        } catch (error) {
          console.error("Failed to train model:", error);
          showAlert("Failed to train model", "danger");
        }
      }

      async function generateAllPredictions() {
        try {
          showAlert("Generating predictions...", "info");
          const result = await apiCall("/prediction/generate-all", "POST");
          showAlert(
            `Generated predictions for ${result.predictions.length} students`,
          );
        } catch (error) {
          console.error("Failed to generate predictions:", error);
          showAlert("Failed to generate predictions", "danger");
        }
      }

      // Debug functions
      function debugAssessments() {
        const output = document.getElementById("debugOutput");
        output.innerHTML = "<h4>üìä Assessments Debug:</h4>";

        fetch("http://localhost:8000/lecturer/assessments/")
          .then((r) => r.json())
          .then((data) => {
            output.innerHTML += `<p>Found <strong>${data.length}</strong> assessments in database</p>`;
            if (data.length > 0) {
              output.innerHTML +=
                "<pre>" + JSON.stringify(data, null, 2) + "</pre>";
            } else {
              output.innerHTML +=
                '<p style="color: orange;">‚ö†Ô∏è No assessments found in database</p>';
            }
          })
          .catch((err) => {
            output.innerHTML +=
              '<p style="color: red;">‚ùå Error: ' + err.message + "</p>";
          });
      }

      function debugStudents() {
        const output = document.getElementById("debugOutput");
        output.innerHTML = "<h4>üë• Students Debug:</h4>";
        output.innerHTML += `<p>Local students array: <strong>${students.length}</strong> students</p>`;
        output.innerHTML +=
          "<pre>" + JSON.stringify(students, null, 2) + "</pre>";
      }

      function debugCourses() {
        const output = document.getElementById("debugOutput");
        output.innerHTML = "<h4>üìö Courses Debug:</h4>";
        output.innerHTML += `<p>Local courses array: <strong>${courses.length}</strong> courses</p>`;
        output.innerHTML +=
          "<pre>" + JSON.stringify(courses, null, 2) + "</pre>";
      }

      function forceReload() {
        console.log("üîÑ Force reloading all data...");
        showAlert("Reloading data...", "info");
        loadAllData();
      }

      // Override the original load functions to use our new ones
      window.loadAssessments = loadAssessments;
      window.loadAttendance = loadAttendance;
    </script>
  </body>
</html>
