<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Academic Performance System</title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
      .risk-badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 0.85rem;
        display: inline-block;
      }
      .risk-badge.high {
        background-color: #ffebee;
        color: #c62828;
        border: 1px solid #ef9a9a;
      }
      .risk-badge.medium {
        background-color: #fff3e0;
        color: #ef6c00;
        border: 1px solid #ffb74d;
      }
      .risk-badge.low {
        background-color: #e8f5e8;
        color: #2e7d32;
        border: 1px solid #a5d6a7;
      }
      .stat-card {
        transition: transform 0.2s;
      }
      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }
      .filter-container {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      .filter-container input,
      .filter-container select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }
      .filter-container input {
        flex: 1;
        min-width: 200px;
      }
      .filter-container select {
        min-width: 150px;
      }
      .metric-card {
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #3498db;
      }
      .metric-value {
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
      }
      .metric-label {
        font-size: 14px;
        color: #7f8c8d;
        margin-top: 5px;
      }
      .refresh-btn {
        background: #3498db;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: background 0.3s;
      }
      .refresh-btn:hover {
        background: #2980b9;
      }
      .refresh-btn:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
      }
      .prediction-warning {
        background-color: #fff3cd;
        color: #856404;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .prediction-warning button {
        margin-left: auto;
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="container">
        <a href="index.html" class="navbar-brand"
          >Academic Performance System</a
        >
        <ul class="navbar-nav">
          <li><a href="index.html">Home</a></li>
          <li><a href="admin.html">Admin</a></li>
          <li><a href="lecturer.html">Lecturer</a></li>
          <li><a href="dashboard.html" class="active">Dashboard</a></li>
        </ul>
      </div>
    </nav>

    <div class="container">
      <!-- Risk Statistics -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Risk Statistics</h2>
          <button
            class="refresh-btn"
            onclick="refreshDashboard()"
            id="refreshBtn"
          >
            <span>‚Üª</span> Refresh Data
          </button>
        </div>

        <div class="stats-grid" id="statistics">
          <!-- Statistics will be loaded here -->
        </div>
      </div>

      <!-- Model Metrics -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Model Performance Metrics</h2>
        </div>
        <div class="metrics-grid" id="metrics">
          <!-- Metrics will be loaded here -->
        </div>
      </div>

      <!-- Prediction Warning (shown if scores are 0) -->
      <div
        id="predictionWarning"
        class="prediction-warning"
        style="display: none"
      >
        <span>‚ö†Ô∏è</span>
        <strong>Prediction scores showing 0.0</strong>
        <span style="flex: 1"
          >This usually means predictions haven't been generated yet.</span
        >
        <button class="btn btn-primary" onclick="generatePredictions()">
          Generate Predictions Now
        </button>
      </div>

      <!-- Students Risk Table -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Student Risk Analysis</h2>
        </div>

        <div class="filter-container">
          <input
            type="text"
            id="searchInput"
            placeholder="Search by name or matric number..."
            onkeyup="filterStudents()"
          />
          <select id="levelFilter" onchange="filterStudents()">
            <option value="">All Levels</option>
            <option value="100">100 Level</option>
            <option value="200">200 Level</option>
            <option value="300">300 Level</option>
            <option value="400">400 Level</option>
            <option value="500">500 Level</option>
          </select>
          <select id="riskFilter" onchange="filterStudents()">
            <option value="">All Risk Levels</option>
            <option value="High">High Risk Only</option>
            <option value="Medium">Medium Risk Only</option>
            <option value="Low">Low Risk Only</option>
          </select>
          <button class="btn btn-secondary" onclick="exportToCSV()">
            Export to CSV
          </button>
        </div>

        <div class="table-responsive">
          <table class="table" id="studentsTable">
            <thead>
              <tr>
                <th>Matric No</th>
                <th>Name</th>
                <th>Level</th>
                <th>Department</th>
                <th>Attendance %</th>
                <th>Assessment Avg</th>
                <th>Predicted Score</th>
                <th>Risk Status</th>
              </tr>
            </thead>
            <tbody id="studentsBody">
              <tr id="loadingRow">
                <td colspan="8" style="text-align: center; padding: 40px">
                  <div class="spinner"></div>
                  <p style="margin-top: 15px; color: #666">
                    Loading student data...
                  </p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div
          id="pagination"
          style="
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
          "
        >
          <!-- Pagination will be added here -->
        </div>
      </div>

      <!-- Debug Panel -->
      <div class="card" style="margin-top: 20px; background-color: #f8f9fa">
        <div class="card-header">
          <h3 class="card-title">üîß Debug Panel</h3>
        </div>
        <div class="card-body">
          <div
            style="
              display: flex;
              gap: 10px;
              flex-wrap: wrap;
              margin-bottom: 15px;
            "
          >
            <button class="btn btn-secondary" onclick="debugPredictions()">
              Debug Predictions
            </button>
            <button class="btn btn-secondary" onclick="debugStudents()">
              Debug Students
            </button>
            <button class="btn btn-secondary" onclick="debugAssessments()">
              Debug Assessments
            </button>
            <button class="btn btn-warning" onclick="forceReload()">
              Force Reload
            </button>
            <button class="btn btn-danger" onclick="testPredictionGeneration()">
              Test Generate Prediction
            </button>
          </div>
          <div
            id="debugOutput"
            style="
              background: white;
              border: 1px solid #ccc;
              border-radius: 5px;
              padding: 15px;
              max-height: 400px;
              overflow: auto;
              font-family: monospace;
              font-size: 12px;
            "
          >
            Click a debug button to see data...
          </div>
        </div>
      </div>
    </div>

    <script src="js/main.js"></script>
    <script>
      // Add spinner animation
      const style = document.createElement("style");
      style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            .spinner {
                display: inline-block;
                width: 40px;
                height: 40px;
                border: 4px solid #f3f3f3;
                border-top: 4px solid #3498db;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
        `;
      document.head.appendChild(style);

      // Global variables
      let allStudents = [];
      let filteredStudents = [];
      let statistics = null;
      let metrics = null;
      let currentPage = 1;
      const rowsPerPage = 10;

      // Load data on page load
      document.addEventListener("DOMContentLoaded", function () {
        console.log("üìä Dashboard loaded");
        loadAllData();
      });

      // Load all dashboard data
      async function loadAllData() {
        showLoading();

        try {
          // Load all data in parallel
          const [stats, modelMetrics, studentsData] = await Promise.all([
            apiCall("/dashboard/statistics").catch((err) => {
              console.error("Failed to load statistics:", err);
              return null;
            }),
            apiCall("/dashboard/model-metrics").catch((err) => {
              console.error("Failed to load metrics:", err);
              return null;
            }),
            apiCall("/dashboard/students").catch((err) => {
              console.error("Failed to load students:", err);
              return [];
            }),
          ]);

          // Update global variables
          statistics = stats;
          metrics = modelMetrics;
          allStudents = studentsData || [];
          filteredStudents = [...allStudents];

          console.log("üìä Data loaded:", {
            statistics: statistics,
            metrics: metrics,
            students: allStudents.length,
          });

          // Check for zero predicted scores
          const hasZeroScores = allStudents.some(
            (s) => s.predicted_score === 0,
          );
          document.getElementById("predictionWarning").style.display =
            hasZeroScores ? "flex" : "none";

          // Display the data
          displayStatistics();
          displayMetrics();
          displayStudents();
        } catch (error) {
          console.error("‚ùå Error loading dashboard data:", error);
          showAlert("Failed to load dashboard data", "danger");
        } finally {
          hideLoading();
        }
      }

      // Show/hide loading
      function showLoading() {
        const tbody = document.getElementById("studentsBody");
        if (tbody) {
          tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px;">
                            <div class="spinner"></div>
                            <p style="margin-top: 15px; color: #666;">Loading student data...</p>
                        </td>
                    </tr>
                `;
        }
      }

      function hideLoading() {
        // Loading is removed when displayStudents is called
      }

      // Display statistics
      function displayStatistics() {
        const statsGrid = document.getElementById("statistics");

        if (!statistics) {
          statsGrid.innerHTML =
            '<p style="text-align: center; padding: 20px;">No statistics available</p>';
          return;
        }

        statsGrid.innerHTML = `
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="stat-label">Total Students</div>
                    <div class="stat-value">${statistics.total_students}</div>
                </div>
                <div class="stat-card low-risk" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;">
                    <div class="stat-label">Low Risk</div>
                    <div class="stat-value">${statistics.low_risk}</div>
                    <div>${statistics.low_risk_percentage?.toFixed(1) || 0}%</div>
                </div>
                <div class="stat-card medium-risk" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white;">
                    <div class="stat-label">Medium Risk</div>
                    <div class="stat-value">${statistics.medium_risk}</div>
                    <div>${statistics.medium_risk_percentage?.toFixed(1) || 0}%</div>
                </div>
                <div class="stat-card high-risk" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white;">
                    <div class="stat-label">High Risk</div>
                    <div class="stat-value">${statistics.high_risk}</div>
                    <div>${statistics.high_risk_percentage?.toFixed(1) || 0}%</div>
                </div>
            `;
      }

      // Display model metrics
      function displayMetrics() {
        const metricsGrid = document.getElementById("metrics");

        if (!metrics || metrics.message) {
          metricsGrid.innerHTML = `
                    <div class="metric-card" style="grid-column: 1/-1;">
                        <p style="color: #666; margin: 0;">${metrics?.message || "No metrics available. Train the model first."}</p>
                    </div>
                `;
          return;
        }

        metricsGrid.innerHTML = `
                <div class="metric-card">
                    <div class="metric-value">${(metrics.accuracy * 100).toFixed(1)}%</div>
                    <div class="metric-label">Accuracy</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${(metrics.precision * 100).toFixed(1)}%</div>
                    <div class="metric-label">Precision</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${(metrics.recall * 100).toFixed(1)}%</div>
                    <div class="metric-label">Recall</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${(metrics.f1_score * 100).toFixed(1)}%</div>
                    <div class="metric-label">F1-Score</div>
                </div>
            `;
      }

      // Display students with pagination
      function displayStudents() {
        const tbody = document.getElementById("studentsBody");

        if (!allStudents || allStudents.length === 0) {
          tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px;">
                            <p style="font-size: 16px; color: #666;">üìä No student data available</p>
                            <p style="font-size: 14px; color: #999; margin-top: 10px;">Add students and generate predictions first</p>
                        </td>
                    </tr>
                `;
          return;
        }

        // Apply filters
        applyFilters();

        // Calculate pagination
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedStudents = filteredStudents.slice(start, end);

        // Build table HTML
        let html = "";
        paginatedStudents.forEach((student) => {
          const riskClass = (student.risk_status || "Low").toLowerCase();
          const attendance = student.attendance_percentage
            ? student.attendance_percentage.toFixed(1)
            : "N/A";
          const assessmentAvg = student.assessment_average
            ? student.assessment_average.toFixed(1)
            : "N/A";
          const predictedScore = student.predicted_score
            ? student.predicted_score.toFixed(1)
            : "0.0";

          // Highlight rows based on risk
          let rowStyle = "";
          if (student.risk_status === "High")
            rowStyle = "background-color: #ffebee;";
          else if (student.risk_status === "Medium")
            rowStyle = "background-color: #fff3e0;";

          html += `
                    <tr style="${rowStyle}">
                        <td><strong>${escapeHtml(student.matric_no || "N/A")}</strong></td>
                        <td>${escapeHtml(student.student_name || "N/A")}</td>
                        <td>${student.level || "N/A"}</td>
                        <td>${escapeHtml(student.department || "N/A")}</td>
                        <td>${attendance}${attendance !== "N/A" ? "%" : ""}</td>
                        <td>${assessmentAvg}</td>
                        <td><strong>${predictedScore}</strong></td>
                        <td><span class="risk-badge ${riskClass}">${student.risk_status || "Unknown"}</span></td>
                    </tr>
                `;
        });

        tbody.innerHTML = html;
        updatePagination();
      }

      // Apply filters
      function applyFilters() {
        const searchTerm =
          document.getElementById("searchInput")?.value.toLowerCase() || "";
        const levelFilter = document.getElementById("levelFilter")?.value || "";
        const riskFilter = document.getElementById("riskFilter")?.value || "";

        filteredStudents = allStudents.filter((student) => {
          // Search filter
          const matchesSearch =
            searchTerm === "" ||
            (student.student_name &&
              student.student_name.toLowerCase().includes(searchTerm)) ||
            (student.matric_no &&
              student.matric_no.toLowerCase().includes(searchTerm));

          // Level filter
          const matchesLevel =
            levelFilter === "" || student.level == levelFilter;

          // Risk filter
          const matchesRisk =
            riskFilter === "" || student.risk_status === riskFilter;

          return matchesSearch && matchesLevel && matchesRisk;
        });

        // Reset to first page when filters change
        currentPage = 1;
      }

      // Filter students (called from input events)
      function filterStudents() {
        displayStudents();
      }

      // Update pagination controls
      function updatePagination() {
        const paginationDiv = document.getElementById("pagination");
        const totalPages = Math.ceil(filteredStudents.length / rowsPerPage);

        if (totalPages <= 1) {
          paginationDiv.innerHTML = "";
          return;
        }

        let paginationHtml =
          '<button class="btn btn-secondary btn-sm" onclick="changePage(1)" ' +
          (currentPage === 1 ? "disabled" : "") +
          ">First</button>";

        paginationHtml +=
          '<button class="btn btn-secondary btn-sm" onclick="changePage(' +
          (currentPage - 1) +
          ')" ' +
          (currentPage === 1 ? "disabled" : "") +
          ">Previous</button>";

        paginationHtml += `<span style="margin: 0 10px; line-height: 30px;">Page ${currentPage} of ${totalPages}</span>`;

        paginationHtml +=
          '<button class="btn btn-secondary btn-sm" onclick="changePage(' +
          (currentPage + 1) +
          ')" ' +
          (currentPage === totalPages ? "disabled" : "") +
          ">Next</button>";

        paginationHtml +=
          '<button class="btn btn-secondary btn-sm" onclick="changePage(' +
          totalPages +
          ')" ' +
          (currentPage === totalPages ? "disabled" : "") +
          ">Last</button>";

        paginationDiv.innerHTML = paginationHtml;
      }

      // Change page
      function changePage(page) {
        currentPage = page;
        displayStudents();
      }

      // Generate predictions
      async function generatePredictions() {
        try {
          const refreshBtn = document.getElementById("refreshBtn");
          refreshBtn.disabled = true;
          refreshBtn.innerHTML = "<span>‚Üª</span> Generating...";

          showAlert("Generating predictions...", "info");

          const result = await apiCall("/prediction/generate-all", "POST");
          showAlert(
            `‚úÖ Generated predictions for ${result.predictions.length} students`,
          );

          // Reload data
          await loadAllData();
        } catch (error) {
          console.error("Failed to generate predictions:", error);
          showAlert(
            "Failed to generate predictions: " + error.message,
            "danger",
          );
        } finally {
          const refreshBtn = document.getElementById("refreshBtn");
          refreshBtn.disabled = false;
          refreshBtn.innerHTML = "<span>‚Üª</span> Refresh Data";
        }
      }

      // Refresh dashboard
      async function refreshDashboard() {
        const refreshBtn = document.getElementById("refreshBtn");
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = "<span>‚Üª</span> Refreshing...";

        await loadAllData();

        refreshBtn.disabled = false;
        refreshBtn.innerHTML = "<span>‚Üª</span> Refresh Data";
      }

      // Force reload
      function forceReload() {
        console.log("üîÑ Force reloading...");
        showAlert("Reloading data...", "info");
        loadAllData();
      }

      // Export to CSV
      function exportToCSV() {
        if (!filteredStudents || filteredStudents.length === 0) {
          showAlert("No data to export", "warning");
          return;
        }

        // Create CSV content
        const headers = [
          "Matric No",
          "Name",
          "Level",
          "Department",
          "Attendance %",
          "Assessment Avg",
          "Predicted Score",
          "Risk Status",
        ];
        const rows = filteredStudents.map((s) => [
          s.matric_no || "N/A",
          s.student_name || "N/A",
          s.level || "N/A",
          s.department || "N/A",
          s.attendance_percentage ? s.attendance_percentage.toFixed(1) : "N/A",
          s.assessment_average ? s.assessment_average.toFixed(1) : "N/A",
          s.predicted_score ? s.predicted_score.toFixed(1) : "0.0",
          s.risk_status || "Unknown",
        ]);

        const csvContent = [
          headers.join(","),
          ...rows.map((row) => row.map((cell) => `"${cell}"`).join(",")),
        ].join("\n");

        // Download CSV
        const blob = new Blob([csvContent], { type: "text/csv" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `student_risk_report_${new Date().toISOString().split("T")[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);

        showAlert(
          `Exported ${filteredStudents.length} students to CSV`,
          "success",
        );
      }

      // Debug functions
      async function debugPredictions() {
        const output = document.getElementById("debugOutput");
        output.innerHTML = "<h4>üîÆ Predictions Debug:</h4>";

        try {
          const predictions = await apiCall("/prediction/all");
          output.innerHTML += `<p>Total predictions: <strong>${predictions.length}</strong></p>`;
          output.innerHTML +=
            "<pre>" + JSON.stringify(predictions, null, 2) + "</pre>";
        } catch (err) {
          output.innerHTML += `<p style="color: red;">‚ùå Error: ${err.message}</p>`;
        }
      }

      async function debugStudents() {
        const output = document.getElementById("debugOutput");
        output.innerHTML = "<h4>üë• Students Debug:</h4>";
        output.innerHTML += `<p>Local students: <strong>${allStudents.length}</strong></p>`;
        output.innerHTML +=
          "<pre>" + JSON.stringify(allStudents, null, 2) + "</pre>";
      }

      async function debugAssessments() {
        const output = document.getElementById("debugOutput");
        output.innerHTML = "<h4>üìù Assessments Debug:</h4>";

        try {
          const assessments = await apiCall("/lecturer/assessments/");
          output.innerHTML += `<p>Total assessments: <strong>${assessments.length}</strong></p>`;
          output.innerHTML +=
            "<pre>" + JSON.stringify(assessments, null, 2) + "</pre>";
        } catch (err) {
          output.innerHTML += `<p style="color: red;">‚ùå Error: ${err.message}</p>`;
        }
      }

      async function testPredictionGeneration() {
        const output = document.getElementById("debugOutput");
        output.innerHTML = "<h4>üß™ Testing Prediction Generation:</h4>";

        try {
          // Get first student
          const students = await apiCall("/admin/students/");
          if (students.length === 0) {
            output.innerHTML +=
              '<p style="color: red;">‚ùå No students found</p>';
            return;
          }

          output.innerHTML += `<p>Testing with student: ${students[0].name}</p>`;

          // Generate prediction for first student
          const result = await apiCall(
            `/prediction/generate/${students[0].id}`,
            "POST",
          );
          output.innerHTML +=
            '<p style="color: green;">‚úÖ Prediction generated:</p>';
          output.innerHTML +=
            "<pre>" + JSON.stringify(result, null, 2) + "</pre>";

          // Refresh dashboard
          await loadAllData();
        } catch (err) {
          output.innerHTML += `<p style="color: red;">‚ùå Error: ${err.message}</p>`;
        }
      }

      // Escape HTML helper
      function escapeHtml(unsafe) {
        if (!unsafe) return unsafe;
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // Make functions global
      window.refreshDashboard = refreshDashboard;
      window.filterStudents = filterStudents;
      window.exportToCSV = exportToCSV;
      window.changePage = changePage;
      window.generatePredictions = generatePredictions;
      window.forceReload = forceReload;
      window.debugPredictions = debugPredictions;
      window.debugStudents = debugStudents;
      window.debugAssessments = debugAssessments;
      window.testPredictionGeneration = testPredictionGeneration;
    </script>
  </body>
</html>
