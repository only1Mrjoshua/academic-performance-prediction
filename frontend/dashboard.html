<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Academic Performance System</title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
      /* Simple statistics grid */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 5px;
        border: 1px solid #ddd;
        text-align: center;
      }

      .stat-label {
        font-size: 14px;
        color: #666;
        margin-bottom: 5px;
      }

      .stat-value {
        font-size: 28px;
        font-weight: bold;
        color: #333;
      }

      .stat-percentage {
        font-size: 14px;
        color: #666;
        margin-top: 5px;
      }

      /* Risk badges */
      .risk-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        display: inline-block;
      }

      .risk-badge.high {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .risk-badge.medium {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
      }

      .risk-badge.low {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      /* Filter container */
      .filter-container {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .filter-container input,
      .filter-container select {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .filter-container input {
        flex: 1;
        min-width: 200px;
      }

      /* Table */
      .table {
        width: 100%;
        border-collapse: collapse;
      }

      .table th {
        background-color: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
      }

      .table td {
        padding: 10px 12px;
        border-bottom: 1px solid #dee2e6;
      }

      .table tr:hover {
        background-color: #f8f9fa;
      }

      /* Buttons */
      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        background-color: #f8f9fa;
        border: 1px solid #ddd;
      }

      .btn-primary {
        background-color: #007bff;
        color: white;
        border: none;
      }

      .btn-primary:hover {
        background-color: #0056b3;
      }

      .btn-secondary {
        background-color: #6c757d;
        color: white;
        border: none;
      }

      .btn-secondary:hover {
        background-color: #545b62;
      }

      .refresh-btn {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
      }

      .refresh-btn:hover {
        background-color: #218838;
      }

      .refresh-btn:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }

      /* Cards */
      .card {
        background: white;
        border-radius: 5px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid #ddd;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }

      .card-title {
        font-size: 18px;
        font-weight: bold;
        margin: 0;
      }

      /* Navigation */
      .navbar {
        background-color: #333;
        padding: 1rem;
        margin-bottom: 20px;
      }

      .navbar .container {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .navbar-brand {
        color: white;
        text-decoration: none;
        font-size: 1.2rem;
        font-weight: bold;
      }

      .navbar-nav {
        list-style: none;
        display: flex;
        gap: 20px;
        margin: 0;
        padding: 0;
      }

      .navbar-nav a {
        color: white;
        text-decoration: none;
        padding: 5px 10px;
      }

      .navbar-nav a:hover,
      .navbar-nav a.active {
        background-color: #555;
        border-radius: 3px;
      }

      /* Spinner */
      .spinner {
        display: inline-block;
        width: 30px;
        height: 30px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Warning */
      .prediction-warning {
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        color: #856404;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* Metrics grid */
      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .metric-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        border: 1px solid #ddd;
        text-align: center;
      }

      .metric-value {
        font-size: 20px;
        font-weight: bold;
        color: #333;
      }

      .metric-label {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }

      /* Pagination */
      #pagination {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        gap: 5px;
      }

      #pagination button {
        padding: 5px 10px;
        border: 1px solid #ddd;
        background: white;
        cursor: pointer;
      }

      #pagination button:hover {
        background: #f8f9fa;
      }

      #pagination button:disabled {
        background: #f8f9fa;
        cursor: not-allowed;
      }

      /* Debug panel */
      .debug-panel {
        background: #f8f9fa;
        border: 1px solid #ddd;
        margin-top: 20px;
      }

      .debug-output {
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        max-height: 300px;
        overflow: auto;
        font-family: monospace;
        font-size: 12px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="container">
        <a href="index.html" class="navbar-brand"
          >Academic Performance System</a
        >
        <ul class="navbar-nav">
          <li><a href="index.html">Home</a></li>
          <li><a href="admin.html">Admin</a></li>
          <li><a href="lecturer.html">Lecturer</a></li>
          <li><a href="dashboard.html" class="active">Dashboard</a></li>
        </ul>
      </div>
    </nav>

    <div class="container">
      <!-- Risk Statistics -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Risk Statistics</h2>
          <button
            class="refresh-btn"
            onclick="refreshDashboard()"
            id="refreshBtn"
          >
            ↻ Refresh
          </button>
        </div>
        <div class="stats-grid" id="statistics">
          <!-- Statistics will be loaded here -->
        </div>
      </div>

      <!-- Model Metrics -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Model Performance</h2>
        </div>
        <div class="metrics-grid" id="metrics">
          <!-- Metrics will be loaded here -->
        </div>
      </div>

      <!-- Prediction Warning -->
      <div
        id="predictionWarning"
        class="prediction-warning"
        style="display: none"
      >
        <span>⚠️</span>
        <strong>No predictions found.</strong>
        <span style="flex: 1">Click the button to generate predictions.</span>
        <button class="btn btn-primary" onclick="generatePredictions()">
          Generate Now
        </button>
      </div>

      <!-- Students Table -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Student Risk Analysis</h2>
        </div>

        <div class="filter-container">
          <input
            type="text"
            id="searchInput"
            placeholder="Search by name or matric..."
            onkeyup="filterStudents()"
          />
          <select id="levelFilter" onchange="filterStudents()">
            <option value="">All Levels</option>
            <option value="100">100 Level</option>
            <option value="200">200 Level</option>
            <option value="300">300 Level</option>
            <option value="400">400 Level</option>
            <option value="500">500 Level</option>
          </select>
          <select id="riskFilter" onchange="filterStudents()">
            <option value="">All Risks</option>
            <option value="High">High Risk</option>
            <option value="Medium">Medium Risk</option>
            <option value="Low">Low Risk</option>
          </select>
          <button class="btn btn-secondary" onclick="exportToCSV()">
            Export CSV
          </button>
        </div>

        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Matric No</th>
                <th>Name</th>
                <th>Level</th>
                <th>Department</th>
                <th>Attendance</th>
                <th>Assessment Avg</th>
                <th>Predicted Score</th>
                <th>Risk Status</th>
              </tr>
            </thead>
            <tbody id="studentsBody">
              <tr>
                <td colspan="8" style="text-align: center; padding: 40px">
                  <div class="spinner"></div>
                  <p style="margin-top: 15px; color: #666">Loading...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div id="pagination"></div>
      </div>

      <!-- Debug Panel -->
      <div class="card debug-panel">
        <div class="card-header">
          <h3 class="card-title">Debug Panel</h3>
        </div>
        <div class="card-body">
          <div
            style="
              display: flex;
              gap: 10px;
              flex-wrap: wrap;
              margin-bottom: 15px;
            "
          >
            <button class="btn" onclick="debugPredictions()">
              Predictions
            </button>
            <button class="btn" onclick="debugStudents()">Students</button>
            <button class="btn" onclick="debugAssessments()">
              Assessments
            </button>
            <button class="btn btn-warning" onclick="forceReload()">
              Force Reload
            </button>
            <button class="btn btn-danger" onclick="testPredictionGeneration()">
              Test Generate
            </button>
          </div>
          <div id="debugOutput" class="debug-output">
            Click a button to see data...
          </div>
        </div>
      </div>
    </div>

    <script src="js/main.js"></script>
    <script>
      // Global variables
      let allStudents = [];
      let filteredStudents = [];
      let statistics = null;
      let metrics = null;
      let currentPage = 1;
      const rowsPerPage = 10;

      // Load data on page load
      document.addEventListener("DOMContentLoaded", function () {
        console.log("Dashboard loaded");
        loadAllData();
      });

      // Load all dashboard data
      async function loadAllData() {
        showLoading();

        try {
          const [stats, modelMetrics, studentsData] = await Promise.all([
            apiCall("/dashboard/statistics").catch((err) => {
              console.error("Failed to load statistics:", err);
              return null;
            }),
            apiCall("/dashboard/model-metrics").catch((err) => {
              console.error("Failed to load metrics:", err);
              return null;
            }),
            apiCall("/dashboard/students").catch((err) => {
              console.error("Failed to load students:", err);
              return [];
            }),
          ]);

          statistics = stats;
          metrics = modelMetrics;
          allStudents = studentsData || [];
          filteredStudents = [...allStudents];

          // Check for zero scores
          const hasZeroScores = allStudents.some(
            (s) => s.predicted_score === 0,
          );
          document.getElementById("predictionWarning").style.display =
            hasZeroScores ? "flex" : "none";

          displayStatistics();
          displayMetrics();
          displayStudents();
        } catch (error) {
          console.error("Error loading data:", error);
          showAlert("Failed to load data", "danger");
        } finally {
          hideLoading();
        }
      }

      function showLoading() {
        const tbody = document.getElementById("studentsBody");
        if (tbody) {
          tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px;">
                            <div class="spinner"></div>
                            <p style="margin-top: 15px;">Loading...</p>
                        </td>
                    </tr>
                `;
        }
      }

      function hideLoading() {}

      function displayStatistics() {
        const statsGrid = document.getElementById("statistics");

        if (!statistics) {
          statsGrid.innerHTML = "<p>No statistics available</p>";
          return;
        }

        statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Students</div>
                    <div class="stat-value">${statistics.total_students}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Low Risk</div>
                    <div class="stat-value">${statistics.low_risk}</div>
                    <div class="stat-percentage">${statistics.low_risk_percentage?.toFixed(1) || 0}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Medium Risk</div>
                    <div class="stat-value">${statistics.medium_risk}</div>
                    <div class="stat-percentage">${statistics.medium_risk_percentage?.toFixed(1) || 0}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">High Risk</div>
                    <div class="stat-value">${statistics.high_risk}</div>
                    <div class="stat-percentage">${statistics.high_risk_percentage?.toFixed(1) || 0}%</div>
                </div>
            `;
      }

      function displayMetrics() {
        const metricsGrid = document.getElementById("metrics");

        if (!metrics || metrics.message) {
          metricsGrid.innerHTML = "<p>No metrics available</p>";
          return;
        }

        metricsGrid.innerHTML = `
                <div class="metric-card">
                    <div class="metric-value">${(metrics.accuracy * 100).toFixed(1)}%</div>
                    <div class="metric-label">Accuracy</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${(metrics.precision * 100).toFixed(1)}%</div>
                    <div class="metric-label">Precision</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${(metrics.recall * 100).toFixed(1)}%</div>
                    <div class="metric-label">Recall</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${(metrics.f1_score * 100).toFixed(1)}%</div>
                    <div class="metric-label">F1-Score</div>
                </div>
            `;
      }

      function displayStudents() {
        const tbody = document.getElementById("studentsBody");

        if (!allStudents || allStudents.length === 0) {
          tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px;">
                            <p>No student data available</p>
                        </td>
                    </tr>
                `;
          return;
        }

        applyFilters();

        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedStudents = filteredStudents.slice(start, end);

        let html = "";
        paginatedStudents.forEach((student) => {
          const riskClass = (student.risk_status || "Low").toLowerCase();
          const attendance = student.attendance_percentage
            ? student.attendance_percentage.toFixed(1)
            : "N/A";
          const assessmentAvg = student.assessment_average
            ? student.assessment_average.toFixed(1)
            : "N/A";
          const predictedScore = student.predicted_score
            ? student.predicted_score.toFixed(1)
            : "0.0";

          html += `
                    <tr>
                        <td>${student.matric_no || "N/A"}</td>
                        <td>${student.student_name || "N/A"}</td>
                        <td>${student.level || "N/A"}</td>
                        <td>${student.department || "N/A"}</td>
                        <td>${attendance}${attendance !== "N/A" ? "%" : ""}</td>
                        <td>${assessmentAvg}</td>
                        <td><strong>${predictedScore}</strong></td>
                        <td><span class="risk-badge ${riskClass}">${student.risk_status || "Unknown"}</span></td>
                    </tr>
                `;
        });

        tbody.innerHTML = html;
        updatePagination();
      }

      function applyFilters() {
        const searchTerm =
          document.getElementById("searchInput")?.value.toLowerCase() || "";
        const levelFilter = document.getElementById("levelFilter")?.value || "";
        const riskFilter = document.getElementById("riskFilter")?.value || "";

        filteredStudents = allStudents.filter((student) => {
          const matchesSearch =
            searchTerm === "" ||
            (student.student_name &&
              student.student_name.toLowerCase().includes(searchTerm)) ||
            (student.matric_no &&
              student.matric_no.toLowerCase().includes(searchTerm));

          const matchesLevel =
            levelFilter === "" || student.level == levelFilter;
          const matchesRisk =
            riskFilter === "" || student.risk_status === riskFilter;

          return matchesSearch && matchesLevel && matchesRisk;
        });

        currentPage = 1;
      }

      function filterStudents() {
        displayStudents();
      }

      function updatePagination() {
        const paginationDiv = document.getElementById("pagination");
        const totalPages = Math.ceil(filteredStudents.length / rowsPerPage);

        if (totalPages <= 1) {
          paginationDiv.innerHTML = "";
          return;
        }

        let html = "";
        for (let i = 1; i <= totalPages; i++) {
          html += `<button onclick="changePage(${i})" ${i === currentPage ? "disabled" : ""}>${i}</button>`;
        }
        paginationDiv.innerHTML = html;
      }

      function changePage(page) {
        currentPage = page;
        displayStudents();
      }

      async function generatePredictions() {
        try {
          const refreshBtn = document.getElementById("refreshBtn");
          refreshBtn.disabled = true;
          refreshBtn.textContent = "Generating...";

          const result = await apiCall("/prediction/generate-all", "POST");
          showAlert(
            `Generated predictions for ${result.predictions.length} students`,
          );
          await loadAllData();
        } catch (error) {
          console.error("Failed to generate predictions:", error);
          showAlert("Failed to generate predictions", "danger");
        } finally {
          const refreshBtn = document.getElementById("refreshBtn");
          refreshBtn.disabled = false;
          refreshBtn.innerHTML = "↻ Refresh";
        }
      }

      async function refreshDashboard() {
        const refreshBtn = document.getElementById("refreshBtn");
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = "↻ Refreshing...";
        await loadAllData();
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = "↻ Refresh";
      }

      function forceReload() {
        loadAllData();
      }

      function exportToCSV() {
        if (!filteredStudents || filteredStudents.length === 0) {
          showAlert("No data to export", "warning");
          return;
        }

        const headers = [
          "Matric No",
          "Name",
          "Level",
          "Department",
          "Attendance %",
          "Assessment Avg",
          "Predicted Score",
          "Risk Status",
        ];
        const rows = filteredStudents.map((s) => [
          s.matric_no || "N/A",
          s.student_name || "N/A",
          s.level || "N/A",
          s.department || "N/A",
          s.attendance_percentage ? s.attendance_percentage.toFixed(1) : "N/A",
          s.assessment_average ? s.assessment_average.toFixed(1) : "N/A",
          s.predicted_score ? s.predicted_score.toFixed(1) : "0.0",
          s.risk_status || "Unknown",
        ]);

        const csvContent = [
          headers.join(","),
          ...rows.map((row) => row.map((cell) => `"${cell}"`).join(",")),
        ].join("\n");

        const blob = new Blob([csvContent], { type: "text/csv" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `student_risk_${new Date().toISOString().split("T")[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
      }

      // Debug functions
      async function debugPredictions() {
        const output = document.getElementById("debugOutput");
        try {
          const data = await apiCall("/prediction/all");
          output.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        } catch (err) {
          output.innerHTML = `Error: ${err.message}`;
        }
      }

      async function debugStudents() {
        const output = document.getElementById("debugOutput");
        output.innerHTML = `<pre>${JSON.stringify(allStudents, null, 2)}</pre>`;
      }

      async function debugAssessments() {
        const output = document.getElementById("debugOutput");
        try {
          const data = await apiCall("/lecturer/assessments/");
          output.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        } catch (err) {
          output.innerHTML = `Error: ${err.message}`;
        }
      }

      async function testPredictionGeneration() {
        const output = document.getElementById("debugOutput");
        try {
          const students = await apiCall("/admin/students/");
          if (students.length === 0) {
            output.innerHTML = "No students found";
            return;
          }
          const result = await apiCall(
            `/prediction/generate/${students[0].id}`,
            "POST",
          );
          output.innerHTML = `<pre>${JSON.stringify(result, null, 2)}</pre>`;
          await loadAllData();
        } catch (err) {
          output.innerHTML = `Error: ${err.message}`;
        }
      }

      // Make functions global
      window.refreshDashboard = refreshDashboard;
      window.filterStudents = filterStudents;
      window.exportToCSV = exportToCSV;
      window.changePage = changePage;
      window.generatePredictions = generatePredictions;
      window.forceReload = forceReload;
      window.debugPredictions = debugPredictions;
      window.debugStudents = debugStudents;
      window.debugAssessments = debugAssessments;
      window.testPredictionGeneration = testPredictionGeneration;
    </script>
  </body>
</html>
